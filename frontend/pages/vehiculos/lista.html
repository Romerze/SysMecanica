<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Veh√≠culos - SysMecanica</title>

    <!-- CSS -->
    <link rel="stylesheet" href="../../assets/css/reset.css">
    <link rel="stylesheet" href="../../assets/css/variables.css">
    <link rel="stylesheet" href="../../assets/css/layout.css">
    <link rel="stylesheet" href="../../assets/css/components.css">
    <link rel="stylesheet" href="../../assets/css/forms.css">
    <link rel="stylesheet" href="../../assets/css/tables.css">
    <link rel="stylesheet" href="../../assets/css/modals.css">
    <link rel="stylesheet" href="../../assets/css/responsive.css">

    <style>
        body {
            min-height: 100vh;
            display: flex;
        }

        .sidebar {
            width: var(--sidebar-width);
            background-color: var(--bg-dark);
            color: var(--white);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            overflow-y: auto;
            z-index: var(--z-fixed);
        }

        .sidebar-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            font-size: var(--font-size-xl);
            font-weight: var(--font-weight-bold);
            text-decoration: none;
            color: var(--white);
        }

        .sidebar-nav {
            padding: var(--spacing-md) 0;
        }

        .nav-item {
            display: block;
            padding: var(--spacing-md) var(--spacing-lg);
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: all var(--transition-fast);
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
            color: var(--white);
        }

        .nav-item.active {
            background-color: rgba(37, 99, 235, 0.2);
            color: var(--white);
            border-left-color: var(--primary-light);
        }

        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            height: var(--header-height);
            background-color: var(--white);
            border-bottom: var(--border-width) solid var(--border-color);
            padding: 0 var(--spacing-lg);
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: var(--z-sticky);
        }

        .content {
            flex: 1;
            padding: var(--spacing-xl) var(--spacing-lg);
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <a href="../dashboard.html" class="sidebar-logo">
                üîß SysMecanica
            </a>
        </div>

        <nav class="sidebar-nav">
            <a href="../dashboard.html" class="nav-item">
                <span class="nav-item-icon">üìä</span> Dashboard
            </a>
            <a href="../clientes/lista.html" class="nav-item">
                <span class="nav-item-icon">üë•</span> Clientes
            </a>
            <a href="lista.html" class="nav-item active">
                <span class="nav-item-icon">üöó</span> Veh√≠culos
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Header -->
        <header class="header">
            <h1 class="header-title">Veh√≠culos</h1>
            <button class="btn btn-secondary btn-sm" id="logoutBtn">Cerrar Sesi√≥n</button>
        </header>

        <!-- Content -->
        <main class="content">
            <!-- Toolbar -->
            <div class="card mb-lg">
                <div class="card-body">
                    <div class="flex justify-between items-center gap-md flex-wrap">
                        <div class="search-box" style="min-width: 300px;">
                            <input
                                type="text"
                                id="searchInput"
                                class="form-control"
                                placeholder="Buscar por placa, marca, modelo..."
                            >
                            <span class="search-icon">üîç</span>
                        </div>

                        <button class="btn btn-primary" onclick="alert('Funcionalidad pr√≥ximamente')">
                            ‚ûï Nuevo Veh√≠culo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tabla de Veh√≠culos -->
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Placa</th>
                                    <th>Marca / Modelo</th>
                                    <th>A√±o</th>
                                    <th>Cliente</th>
                                    <th>Tel√©fono</th>
                                    <th>√ìrdenes</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="vehiculosTableBody">
                                <tr>
                                    <td colspan="7" class="text-center py-lg">
                                        <div class="spinner spinner-lg"></div>
                                        Cargando veh√≠culos...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginaci√≥n -->
                    <div class="table-pagination">
                        <div class="text-sm text-secondary">
                            Mostrando <span id="showingFrom">0</span> a <span id="showingTo">0</span> de <span id="totalVehiculos">0</span> veh√≠culos
                        </div>

                        <ul class="pagination" id="pagination"></ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- JavaScript -->
    <script src="../../assets/js/api/client.js"></script>
    <script src="../../assets/js/utils/storage.js"></script>
    <script src="../../assets/js/utils/notifications.js"></script>

    <script>
        // Verificar autenticaci√≥n
        if (!storage.auth.isAuthenticated()) {
            window.location.href = '../index.html';
        }

        let currentPage = 1;
        let totalPages = 1;
        let searchTimeout;

        // Cargar veh√≠culos
        async function loadVehiculos(page = 1, search = '') {
            try {
                const params = { page, limit: 20 };
                if (search) params.search = search;

                const response = await api.get('/vehiculos', params);

                displayVehiculos(response.vehiculos);
                displayPagination(response.pagination);

                currentPage = page;
                totalPages = response.pagination.totalPages;
            } catch (error) {
                console.error('Error:', error);
                notifications.error('Error al cargar veh√≠culos');
            }
        }

        // Mostrar veh√≠culos
        function displayVehiculos(vehiculos) {
            const tbody = document.getElementById('vehiculosTableBody');

            if (vehiculos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-xl">
                            <div class="empty-state">
                                <div class="empty-state-icon">üöó</div>
                                <h3 class="empty-state-title">No hay veh√≠culos</h3>
                                <p class="empty-state-text">Comienza registrando el primer veh√≠culo</p>
                            </div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = vehiculos.map(v => `
                <tr>
                    <td><strong>${v.placa}</strong></td>
                    <td>${v.marca} ${v.modelo}</td>
                    <td>${v.anio || '-'}</td>
                    <td>${v.cliente_nombre} ${v.cliente_apellido}</td>
                    <td>${v.cliente_telefono || '-'}</td>
                    <td><span class="badge badge-primary">${v.total_ordenes}</span></td>
                    <td>
                        <button class="btn btn-sm btn-secondary" title="Ver detalle">üëÅÔ∏è</button>
                    </td>
                </tr>
            `).join('');
        }

        // Mostrar paginaci√≥n
        function displayPagination(pagination) {
            document.getElementById('showingFrom').textContent = pagination.total === 0 ? 0 : ((pagination.page - 1) * pagination.limit + 1);
            document.getElementById('showingTo').textContent = Math.min(pagination.page * pagination.limit, pagination.total);
            document.getElementById('totalVehiculos').textContent = pagination.total;

            const paginationEl = document.getElementById('pagination');
            if (pagination.totalPages <= 1) {
                paginationEl.innerHTML = '';
                return;
            }

            let pages = `
                <li class="page-item ${pagination.page === 1 ? 'disabled' : ''}">
                    <a class="page-link" onclick="${pagination.page > 1 ? `loadVehiculos(${pagination.page - 1}, document.getElementById('searchInput').value)` : ''}">‚Äπ</a>
                </li>
            `;

            for (let i = 1; i <= pagination.totalPages; i++) {
                if (i === 1 || i === pagination.totalPages || (i >= pagination.page - 1 && i <= pagination.page + 1)) {
                    pages += `
                        <li class="page-item ${i === pagination.page ? 'active' : ''}">
                            <a class="page-link" onclick="loadVehiculos(${i}, document.getElementById('searchInput').value)">${i}</a>
                        </li>
                    `;
                } else if (i === pagination.page - 2 || i === pagination.page + 2) {
                    pages += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            pages += `
                <li class="page-item ${pagination.page === pagination.totalPages ? 'disabled' : ''}">
                    <a class="page-link" onclick="${pagination.page < pagination.totalPages ? `loadVehiculos(${pagination.page + 1}, document.getElementById('searchInput').value)` : ''}">‚Ä∫</a>
                </li>
            `;

            paginationEl.innerHTML = pages;
        }

        // B√∫squeda
        document.getElementById('searchInput').addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => loadVehiculos(1, e.target.value), 500);
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', () => {
            storage.auth.clear();
            window.location.href = '../index.html';
        });

        // Cargar veh√≠culos al inicio
        loadVehiculos();
    </script>
</body>
</html>
